module Alces
  module Forge
    class PackageMetadata
      def self.load_from_api(api, user, package, version=nil)
        params = {
            'filter[username]' => user,
            'filter[name]' => package,
            :sort => '-version'
        }

        if version
          params['filter[version]'] = version
        else
          params['sort'] = '-version'  # 'Newest' first (assuming sensible ordering from the server)
          # NB We can't sort on the standard Rails attributes (createdAt / updatedAt) since these will all read the
          # same for the Alces autogenerated packages, and earlier versions might be added later anyway.
        end

        metadata = api.get('packages', params: params)['data'].first

        raise 'No matching package found' unless metadata

        new(metadata)
      end

      def method_missing(s, *a, &_)
        if metadata.has_key?(s)
          metadata[s]
        elsif metadata['attributes'].has_key?(s)
          metadata['attributes'][s]
        else
          nil
        end
      end

      private

      def new(metadata)
        @metadata = metadata
      end

      def metadata
        @metadata
      end

    end
  end
end
